@model Application.ViewModels.CustomerIndexViewModel

@{
    ViewData["Title"] = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}


<div id="view">
    @await Html.PartialAsync("_IndexPartial", Model)
</div>

<div class="modal fade" tabindex="-1" role="dialog" id="modal">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"></h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
            </div>
        </div>
    </div>
</div>

@section Scripts{
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}

    <script>
        const $view = $("#view");
        const $modal = $("#modal");
        const $modalTitle = $("#modal .modal-title");
        const $modalBoby = $("#modal .modal-body");
        const $modalDialog = $("#modal .modal-dialog");
        const $pages = $("#navigation > .pagination li.page-item").not('.disabled');
        let $search = $("#SearchString");

        $(function () {

            $pages.on("click", function (e) {
                e.preventDefault();
                let pageNumber = $(this).data("num");

                jQueryAjaxPagePost(pageNumber);
            });

        });


        jQueryAjaxPagePost = (pageNumber) => {

            console.log($search.val(), $("#SearchString").val());

            let model = {
                "SearchString": $("#SearchString").val(),
                "PageNumber": pageNumber,
                "TotalPages": undefined,
                "HasPreviousPage": undefined,
                "HasNextPage": undefined,
                "CustomerViewModelList": []
            };

            $.ajax({
                type: "POST",
                url: "/Customer/Index",
                dataType: "json",
                contentType: "application/json; charset=utf-8",
                data: JSON.stringify(model),
                processData: false,
                beforeSend: function (xhr) {
                    xhr.setRequestHeader("X-XSRF-TOKEN",
                        $('input:hidden[name="__RequestVerificationToken"]').val());
                }
            }).done(function (res) {
                if (res.isValid) {
                    $view.html(res.html)
                }
            }).fail(function (jqXHR, textStatus, errorThrown) {
                console.log(jqXHR, textStatus, errorThrown);
            });
        }


        showInPopup = (url, title) => {
            $.ajax({
                type: "GET",
                url: url
            }).done(function (res) {
                $modalBoby.html(res.html);
                $modalTitle.html(title);
                $modal.modal("show");
                // to make popup draggable
                $modalDialog.draggable({
                    handle: ".modal-header"
                });
            }).fail(function (jqXHR, textStatus, errorThrown) {
                console.log(jqXHR, textStatus, errorThrown);
            });
        }

        //搜尋
        jQueryAjaxSearchPost = form => {

            //var data = JSON.stringify($(form).serializeArray());

            //console.log(data);

            //let model = {
            //    "SearchString": "",
            //    "PageNumber": pageNumber,
            //    "TotalPages": undefined,
            //    "HasPreviousPage": undefined,
            //    "HasNextPage": undefined,
            //    "CustomerViewModelList": []
            //};

            try {
                $.ajax({
                    type: "POST",
                    url: form.action,
                    data: new FormData(form),
                    contentType: false,
                    processData: false
                }).done(function (res) {
                    if (res.isValid) {
                        $view.html(res.html)
                    }
                }).fail(function (jqXHR, textStatus, errorThrown) {
                    console.log(jqXHR, textStatus, errorThrown);
                });
                //to prevent default form submit event
                return false;
            } catch (ex) {
                console.log(ex)
            }
        }

        //新增或編輯
        jQueryAjaxPost = form => {
            try {
                $.ajax({
                    type: "POST",
                    url: form.action,
                    data: new FormData(form),
                    contentType: false,
                    processData: false
                }).done(function (res) {
                    if (res.isValid) {
                        $view.html(res.html)
                        $modalBoby.html("");
                        $modalTitle.html("");
                        $modal.modal("hide");
                    }
                    else
                        $modalBoby.html(res.html);
                }).fail(function (jqXHR, textStatus, errorThrown) {
                    console.log(jqXHR, textStatus, errorThrown);
                });
                //to prevent default form submit event
                return false;
            } catch (ex) {
                console.log(ex)
            }
        }

        //刪除
        jQueryAjaxDelete = (url, id) => {
            if (confirm("你確定要刪除嗎?")) {
                try {
                    $.ajax({
                        type: "Delete",
                        url: url,
                        data: JSON.stringify({ id: id }),
                        contentType: false, //sending data to the server , default: 'application/x-www-form-urlencoded; charset=UTF-8'
                        processData: false
                    }).done(function (res) {
                        $view.html(res.html);
                    }).fail(function (jqXHR, textStatus, errorThrown) {
                        console.log(jqXHR, textStatus, errorThrown);
                    });
                } catch (ex) {
                    console.log(ex)
                }
            }

            return false;
        }
    </script>
}
